#!/bin/bash
PUT="CVE-2018-10685"
runmode=$1
timeout=$2
targets=$3

# Checkout source code
git clone https://github.com/ckolivas/lrzip.git $PUT
cd $PUT; export SUBJECT=$PWD;
git checkout 9de7ccb

# Compile source code
./autogen.sh; make distclean
rm -rf obj; mkdir obj; cd obj;
CFLAGS="-g -m32" CXXFLAGS="-g -m32" ../configure --prefix=`pwd`
make clean; make
cd $SUBJECT; rm -rf obj-asan; mkdir obj-asan; cd obj-asan
CFLAGS="-g -m32 -fsanitize=address" CXXFLAGS="-g -m32 -fsanitize=address" ../configure --prefix=`pwd`
make clean; make

# Prepare working directories
cd $SUBJECT; rm -rf obj-$runmode; mkdir obj-$runmode; export FUZZ_DIR=$SUBJECT/obj-$runmode; cd $FUZZ_DIR
mkdir in; cp $UAFBENCH_PATH/seeds/$PUT/* in

# Fuzzing
if [ $runmode = "aflqemu" ]; then
	cp $SUBJECT/obj/lrzip .
	timeout -sHUP ${timeout}m $SCRIPTS/run_afl.py -f $FUZZ_DIR/lrzip -Q -i $FUZZ_DIR/in -o run -r "$FUZZ_DIR/lrzip -t @@" -to $timeout
elif [ $runmode = "aflgo" ]; then
	SECONDS=0
	export AFL_PATH=$HOME/aflgo; export AFLGO=$AFL_PATH
	mkdir temp; export TMP_DIR=$FUZZ_DIR/temp
	export CC=$AFLGO/afl-clang-fast; export CXX=$AFLGO/afl-clang-fast++
	export LDFLAGS=-lpthread
	export ADDITIONAL="-targets=$TMP_DIR/BBtargets.txt -outdir=$TMP_DIR -flto -fuse-ld=gold -Wl,-plugin-opt=save-temps"
	echo $'main.c:669\nlrzip.c:826\nrunzip.c:382\nrunzip.c:304\nstream.c:1082\nrunzip.c:361\nstream.c:1839\nstream.c:1522\nstream.c:564' > $TMP_DIR/BBtargets.txt
	CFLAGS="$ADDITIONAL" CXXFLAGS="$ADDITIONAL" ../configure --prefix=`pwd`
	make clean; make
	cat $TMP_DIR/BBnames.txt | rev | cut -d: -f2- | rev | sort | uniq > $TMP_DIR/BBnames2.txt && mv $TMP_DIR/BBnames2.txt $TMP_DIR/BBnames.txt
	cat $TMP_DIR/BBcalls.txt | sort | uniq > $TMP_DIR/BBcalls2.txt && mv $TMP_DIR/BBcalls2.txt $TMP_DIR/BBcalls.txt
	$AFLGO/scripts/genDistance.sh $SUBJECT $TMP_DIR lrzip
	CFLAGS="-distance=$TMP_DIR/distance.cfg.txt" CXXFLAGS="-distance=$TMP_DIR/distance.cfg.txt" ../configure --prefix=`pwd`
	make clean; make
	pp_aflgo_time=$SECONDS; echo "pp_aflgo_time: $pp_aflgo_time (s)."
	timeout -sHUP "${timeout}m" $AFLGO/afl-fuzz -m none -z exp -c 45m -i in -o out $FUZZ_DIR/lrzip -t @@
elif [ $1 = "aflgob" ] || [ $1 = "heb" ] || [ $1 = "uafuzz" ]; then
	cp $SUBJECT/obj/lrzip $PUT; cp $targets .
	# $UAFUZZ_PATH/scripts/preprocess.py -f $PUT -v $targets -o $FUZZ_DIR
	echo $'0x804cf24,main\n0x8050909,decompress_file\n0x805b2d3,runzip_fd\n0x805ac8e,runzip_chunk\n0x805f666,open_stream_in\n0x805b1cf,runzip_chunk\n0x8062dac,close_stream_in\n0x806173a,ucompthread' > "$FUZZ_DIR/$PUT.tgt"
	echo $'0x804cf24,main;0x8050909,decompress_file\n0x8050909,decompress_file;0x805b2d3,runzip_fd\n0x805b2d3,runzip_fd;0x805ac8e,runzip_chunk\n0x805ac8e,runzip_chunk;0x805f666,open_stream_in\n0x805ac8e,runzip_chunk;0x805b1cf,runzip_chunk\n0x805b1cf,runzip_chunk;0x8062dac,close_stream_in\n0x8062dac,close_stream_in;0x806173a,ucompthread' > "$FUZZ_DIR/$PUT.tgt_cut"
	echo $'0x805f666,open_stream_in\n0x8062dac,close_stream_in\n0x806173a,ucompthread' > "$FUZZ_DIR/$PUT.tgt_uaf"
	$UAFUZZ_PATH/scripts/run_uafuzz.py -f $FUZZ_DIR/$PUT -M fuzz -i $FUZZ_DIR/in -o run -r "$FUZZ_DIR/$PUT -t @@" -I $runmode -T "$FUZZ_DIR/$PUT.tgt" -to $timeout
fi
